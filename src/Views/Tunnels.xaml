<UserControl
    x:Class="OpenFrp.Launcher.Views.Tunnels"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:awe="clr-namespace:Awe.UI.Controls;assembly=Awe.UI"
    xmlns:behavior="http://schemas.microsoft.com/xaml/behaviors"
    xmlns:converter="clr-namespace:Awe.UI.Converter;assembly=Awe.UI"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:OpenFrp.Launcher.Views"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:sys="clr-namespace:System;assembly=mscorlib"
    xmlns:vm="clr-namespace:OpenFrp.Launcher.ViewModels"
    d:DesignHeight="450"
    d:DesignWidth="800"
    d:Foreground="White"
    mc:Ignorable="d">
    <behavior:Interaction.Triggers>
        <behavior:EventTrigger EventName="Loaded">
            <behavior:InvokeCommandAction Command="{Binding event_PageLoadedCommand}" />
        </behavior:EventTrigger>
    </behavior:Interaction.Triggers>
    <UserControl.Resources>
        <converter:EqualConverter x:Key="EqualConverter" />
        <converter:NotEqualConverter x:Key="NotEqualConverter" />
        <converter:BothConverter x:Key="BothConverter" />
        <converter:CollectionContainConverter x:Key="CollectionContainConverter" />
    </UserControl.Resources>
    <UserControl.DataContext>
        <vm:TunnelsViewModel />
    </UserControl.DataContext>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>
        <TextBlock
            Margin="28,48,28,4"
            FontSize="24"
            Text="隧道" />
        <Grid Grid.Row="1">
            <!--  这里应直接加载，不需要再次请求  -->
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <Grid>
                    <Grid Margin="28,0">
                        <ItemsControl
                            x:Name="ic"
                            Margin="0,12,0,14"
                            Focusable="False"
                            ItemsSource="{Binding UserTunnels, Mode=OneWay}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel Orientation="Horizontal" />
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <ContentControl
                                        Width="300"
                                        Height="168.75"
                                        Margin="0,0,12,12">
                                        <ContentControl.FocusVisualStyle>
                                            <Style>
                                                <Setter Property="Control.Template">
                                                    <Setter.Value>
                                                        <ControlTemplate>
                                                            <Border
                                                                Margin="-4"
                                                                BorderBrush="White"
                                                                BorderThickness="2"
                                                                CornerRadius="3"
                                                                SnapsToDevicePixels="True">
                                                                <Border
                                                                    BorderBrush="Black"
                                                                    BorderThickness="2"
                                                                    CornerRadius="3" />
                                                            </Border>
                                                        </ControlTemplate>
                                                    </Setter.Value>
                                                </Setter>
                                            </Style>
                                        </ContentControl.FocusVisualStyle>
                                        <Grid>
                                            <Border
                                                CornerRadius="3"
                                                Opacity=".6"
                                                RenderTransformOrigin=".5,.5">
                                                <Border.RenderTransform>
                                                    <ScaleTransform ScaleX=".96" ScaleY=".96" />
                                                </Border.RenderTransform>
                                                <Border.Effect>
                                                    <BlurEffect Radius="25" />
                                                </Border.Effect>
                                                <Border.Background>
                                                    <LinearGradientBrush StartPoint=".5,.10">
                                                        <GradientStop Color="{DynamicResource Awe.UI.AccentLinearGradient.1}" />
                                                        <GradientStop Offset="1" Color="{DynamicResource Awe.UI.AccentLinearGradient.2}" />
                                                    </LinearGradientBrush>
                                                </Border.Background>
                                            </Border>
                                            <Border CornerRadius="3">
                                                <Border.Background>
                                                    <LinearGradientBrush StartPoint=".5,.10">
                                                        <GradientStop Color="{DynamicResource Awe.UI.AccentLinearGradient.1}" />
                                                        <GradientStop Offset="1" Color="{DynamicResource Awe.UI.AccentLinearGradient.2}" />
                                                    </LinearGradientBrush>
                                                </Border.Background>
                                            </Border>
                                            <Border
                                                Background="#20000000"
                                                CornerRadius="3"
                                                TextElement.Foreground="White">
                                                <Grid Margin="20,20,22,20">
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto" />
                                                        <RowDefinition Height="*" />
                                                        <RowDefinition Height="Auto" />
                                                    </Grid.RowDefinitions>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="Auto" />
                                                    </Grid.ColumnDefinitions>
                                                    <!--  标题 + ID  -->
                                                    <WrapPanel
                                                        Grid.Row="0"
                                                        Grid.Column="0"
                                                        VerticalAlignment="Top"
                                                        Orientation="Horizontal">
                                                        <TextBlock
                                                            Margin="0,0,2,0"
                                                            FontFamily="{StaticResource Montserrat}"
                                                            FontSize="20"
                                                            FontWeight="Medium"
                                                            Text="{Binding Name, Mode=OneWay}" />
                                                        <TextBlock
                                                            VerticalAlignment="Bottom"
                                                            FontFamily="{StaticResource Montserrat}"
                                                            FontSize="14"
                                                            FontWeight="Medium"
                                                            Foreground="#9fffffff"
                                                            Text="{Binding Id, StringFormat='#{0}', Mode=OneWay}" />
                                                    </WrapPanel>
                                                    <!--  隧道附加属性  -->
                                                    <StackPanel
                                                        Grid.Row="1"
                                                        Grid.Column="0"
                                                        Margin="0,2,0,0"
                                                        Orientation="Vertical"
                                                        TextElement.Foreground="#8fffffff">
                                                        <WrapPanel>
                                                            <awe:VisibilityTranstion IsDisplay="{Binding UseEncryption, Mode=OneWay}">
                                                                <TextBlock FontSize="14" Text="启用数据加密" />
                                                            </awe:VisibilityTranstion>
                                                            <awe:VisibilityTranstion>
                                                                <awe:VisibilityTranstion.IsDisplay>
                                                                    <MultiBinding Converter="{StaticResource BothConverter}">
                                                                        <Binding Mode="OneWay" Path="UseCompression" />
                                                                        <Binding Mode="OneWay" Path="UseEncryption" />
                                                                    </MultiBinding>
                                                                </awe:VisibilityTranstion.IsDisplay>
                                                                <TextBlock FontSize="14" Text="," />
                                                            </awe:VisibilityTranstion>
                                                            <awe:VisibilityTranstion IsDisplay="{Binding UseCompression, Mode=OneWay}">
                                                                <TextBlock FontSize="14" Text="启用数据压缩" />
                                                            </awe:VisibilityTranstion>
                                                        </WrapPanel>
                                                        <WrapPanel>
                                                            <awe:VisibilityTranstion IsDisplay="{Binding RemotePort, Converter={StaticResource NotEqualConverter}, ConverterParameter={x:Null}, Mode=OneWay}">
                                                                <TextBlock
                                                                    FontFamily="{StaticResource Montserrat}"
                                                                    FontSize="14"
                                                                    FontWeight="Medium"
                                                                    Text="{Binding RemotePort, StringFormat='{}{0} → ', Mode=OneWay}" />
                                                            </awe:VisibilityTranstion>

                                                            <TextBlock
                                                                FontFamily="{StaticResource Montserrat}"
                                                                FontSize="14"
                                                                FontWeight="Medium">
                                                                <TextBlock.ToolTip>
                                                                    <TextBlock MaxWidth="200" TextWrapping="Wrap">
                                                                        <Run FontWeight="Bold">
                                                                            <MultiBinding StringFormat="本地服务 {0}:{1}">
                                                                                <Binding Mode="OneWay" Path="Host" />
                                                                                <Binding Mode="OneWay" Path="Port" />
                                                                            </MultiBinding>
                                                                        </Run>
                                                                        <LineBreak />
                                                                        <Run Text="FRPC 需要使用该链接，若该服务未开启(比如 Minecraft 服务器)，则客户端无法进入" />
                                                                    </TextBlock>
                                                                </TextBlock.ToolTip>
                                                                <TextBlock.Text>
                                                                    <MultiBinding StringFormat="{}{0}:{1}">
                                                                        <Binding Mode="OneWay" Path="Host" />
                                                                        <Binding Mode="OneWay" Path="Port" />
                                                                    </MultiBinding>
                                                                </TextBlock.Text>
                                                            </TextBlock>
                                                        </WrapPanel>
                                                    </StackPanel>

                                                    <!--  操作  -->
                                                    <StackPanel
                                                        Grid.Row="0"
                                                        Grid.Column="1"
                                                        VerticalAlignment="Center"
                                                        Orientation="Horizontal">
                                                        <awe:Loading
                                                            Width="16"
                                                            Height="16"
                                                            Margin="8,0,8,0"
                                                            FontSize="2"
                                                            IsEnabled="{Binding IsEnabled, Converter={StaticResource NotEqualConverter}, ConverterParameter='True', ElementName=tg, Mode=OneWay}"
                                                            Style="{StaticResource Default2}" />
                                                        <awe:ToggleSwitch x:Name="tg" VerticalAlignment="Center">
                                                            <awe:ToggleSwitch.IsChecked>
                                                                <MultiBinding
                                                                    Converter="{StaticResource CollectionContainConverter}"
                                                                    ConverterParameter="{x:Type sys:Int32}"
                                                                    Mode="OneTime">
                                                                    <Binding
                                                                        Mode="OneWay"
                                                                        Path="DataContext.OnlineTunnels"
                                                                        Source="{x:Reference Name=ic}" />
                                                                    <Binding Mode="OneWay" Path="Id" />
                                                                </MultiBinding>
                                                            </awe:ToggleSwitch.IsChecked>
                                                            <behavior:Interaction.Triggers>
                                                                <behavior:EventTrigger EventName="Loaded">
                                                                    <behavior:InvokeCommandAction Command="{Binding DataContext.event_SwitchLoadedCommand, Source={x:Reference ic}, Mode=OneWay}" PassEventArgsToCommand="True" />
                                                                </behavior:EventTrigger>
                                                            </behavior:Interaction.Triggers>
                                                            <awe:ToggleSwitch.LayoutTransform>
                                                                <ScaleTransform ScaleX=".8" ScaleY=".8" />
                                                            </awe:ToggleSwitch.LayoutTransform>
                                                        </awe:ToggleSwitch>
                                                    </StackPanel>

                                                    <Grid
                                                        Grid.Row="2"
                                                        Grid.Column="0"
                                                        Grid.ColumnSpan="2">
                                                        <TextBlock
                                                            FontSize="14"
                                                            FontWeight="Medium"
                                                            Foreground="#6fffffff">
                                                            <Run FontFamily="{StaticResource Montserrat}" Text="{Binding Type, Mode=OneWay}" />
                                                            <Run FontFamily="{StaticResource Montserrat}" Text="{Binding NodeId, StringFormat='#{0}', Mode=OneWay}" />
                                                            <Run Text="{Binding NodeName, Mode=OneWay}" />
                                                        </TextBlock>
                                                        <awe:NavigationButton
                                                            Margin="0,0,2,0"
                                                            HorizontalAlignment="Right"
                                                            Command="{Binding DataContext.event_DisplayMenuCommand, Source={x:Reference ic}, Mode=OneWay}"
                                                            Cursor="Hand"
                                                            IsEnabled="{Binding IsEnabled, ElementName=tg, Mode=OneWay}"
                                                            ToolTip="更多">
                                                            <awe:NavigationButton.CommandParameter>
                                                                <ContextMenu Width="145" TextElement.Foreground="White">
                                                                    <MenuItem Header="编辑隧道">
                                                                        <MenuItem.Icon>
                                                                            <Path
                                                                                Width="16"
                                                                                Height="16"
                                                                                Margin="0,0,8,0"
                                                                                Data="{DynamicResource Awe.UI.Icons.Edit}"
                                                                                Fill="White"
                                                                                Stretch="Uniform" />
                                                                        </MenuItem.Icon>
                                                                    </MenuItem>
                                                                    <MenuItem Header="删除隧道">
                                                                        <MenuItem.Icon>
                                                                            <Path
                                                                                Width="16"
                                                                                Height="16"
                                                                                Margin="0,0,8,0"
                                                                                Data="{DynamicResource Awe.UI.Icons.Delete}"
                                                                                Fill="White"
                                                                                Stretch="Uniform" />
                                                                        </MenuItem.Icon>
                                                                    </MenuItem>
                                                                </ContextMenu>
                                                            </awe:NavigationButton.CommandParameter>
                                                            <Path
                                                                Width="16"
                                                                Height="16"
                                                                Data="{DynamicResource Awe.UI.Icons.More}"
                                                                Fill="White"
                                                                Stretch="Uniform" />
                                                        </awe:NavigationButton>
                                                    </Grid>
                                                </Grid>
                                            </Border>
                                        </Grid>
                                    </ContentControl>

                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Grid>
                </Grid>
            </ScrollViewer>
        </Grid>

    </Grid>
</UserControl>
